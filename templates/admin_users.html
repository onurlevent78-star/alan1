<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kullanıcı Yönetimi - Rezervasyon Sistemi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            border: none;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        .navbar {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .permission-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            margin: 1px;
            border-radius: 8px;
        }
        .table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            border: none;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" href="{{ url_for('index') }}">
                <i class="fas fa-calendar-check me-2"></i>Rezervasyon Sistemi
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('index') }}">
                    <i class="fas fa-home me-1"></i>Ana Sayfa
                </a>
                {% if session.user_permissions and 'view_reservations' in session.user_permissions %}
                <a class="nav-link" href="{{ url_for('reservations_list') }}">
                    <i class="fas fa-list me-1"></i>Rezervasyonlar
                </a>
                {% endif %}
                {% if session.user_permissions and 'view_availability' in session.user_permissions %}
                <a class="nav-link" href="{{ url_for('availability_view') }}">
                    <i class="fas fa-clock me-1"></i>Saat Durumu
                </a>
                {% endif %}
                <span class="nav-link text-muted">
                    <i class="fas fa-user me-1"></i>{{ session.user_id }}
                    <span class="badge bg-danger ms-1">Admin</span>
                </span>
                <a class="nav-link" href="{{ url_for('logout') }}">
                    <i class="fas fa-sign-out-alt me-1"></i>Çıkış
                </a>
            </div>
        </div>
    </nav>

    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'success' if category == 'success' else ('warning' if category == 'warning' else 'danger') }} alert-dismissible fade show" role="alert">
                        <i class="fas fa-{{ 'check-circle' if category == 'success' else ('exclamation-triangle' if category == 'warning' else 'exclamation-circle') }} me-2"></i>{{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Kullanıcı Listesi -->
        <div class="card mb-4">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-users me-2"></i>Kullanıcı Yönetimi
                </h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Kullanıcı Adı</th>
                                <th>Rol</th>
                                <th>Yetkiler</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for username, user_data in users.items() %}
                            <tr>
                                <td>
                                    <i class="fas fa-user me-2"></i>{{ username }}
                                    {% if username == session.user_id %}
                                        <span class="badge bg-info ms-2">Sen</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user_data.role == 'admin' %}
                                        <span class="badge bg-danger">Admin</span>
                                    {% elif user_data.role == 'manager' %}
                                        <span class="badge bg-warning">Yönetici</span>
                                    {% elif user_data.role == 'viewer' %}
                                        <span class="badge bg-info">Görüntüleyici</span>
                                    {% elif user_data.role == 'scheduler' %}
                                        <span class="badge bg-success">Planlamacı</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Kullanıcı</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% for permission in user_data.permissions %}
                                        {% if permission == 'view_reservations' %}
                                            <span class="permission-badge badge bg-primary">Rezervasyon Listesi</span>
                                        {% elif permission == 'edit_reservations' %}
                                            <span class="permission-badge badge bg-warning">Rezervasyon Düzenleme</span>
                                        {% elif permission == 'view_availability' %}
                                            <span class="permission-badge badge bg-info">Saat Durumu</span>
                                        {% elif permission == 'manage_users' %}
                                            <span class="permission-badge badge bg-danger">Kullanıcı Yönetimi</span>
                                        {% endif %}
                                    {% endfor %}
                                    {% if not user_data.permissions %}
                                        <span class="text-muted">Sadece rezervasyon oluşturma</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="editPermissions('{{ username }}')" title="Yetkileri Düzenle">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning ms-1" 
                                            onclick="resetPassword('{{ username }}')" 
                                            title="Şifreyi Resetle"
                                            {% if username == session.user_id %}disabled{% endif %}>
                                        <i class="fas fa-key"></i>
                                    </button>
                                    {% if username != session.user_id %}
                                    <a href="{{ url_for('delete_user', username=username) }}" 
                                       class="btn btn-sm btn-outline-danger ms-1" 
                                       onclick="return confirm('{{ username }} kullanıcısını silmek istediğinizden emin misiniz?')" 
                                       title="Kullanıcıyı Sil">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Yeni Kullanıcı Ekleme -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-user-plus me-2"></i>Yeni Kullanıcı Ekle
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('add_user') }}">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="username" class="form-label">Kullanıcı Adı</label>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                        <div class="col-md-4">
                            <label for="password" class="form-label">Şifre</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        <div class="col-md-4">
                            <label for="role" class="form-label">Rol</label>
                            <select class="form-control" id="role" name="role">
                                <option value="user">Kullanıcı</option>
                                <option value="viewer">Görüntüleyici</option>
                                <option value="scheduler">Planlamacı</option>
                                <option value="manager">Yönetici</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-plus me-2"></i>Kullanıcı Ekle
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Yetki Düzenleme Modal -->
    <div class="modal fade" id="permissionsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Kullanıcı Yetkileri</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="permissionsForm" method="POST">
                    <div class="modal-body">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="permissions" value="view_reservations" id="perm_view_reservations">
                            <label class="form-check-label" for="perm_view_reservations">
                                <i class="fas fa-list me-2"></i>Rezervasyon Listesini Görüntüleme
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="permissions" value="edit_reservations" id="perm_edit_reservations">
                            <label class="form-check-label" for="perm_edit_reservations">
                                <i class="fas fa-edit me-2"></i>Rezervasyon Düzenleme
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="permissions" value="view_availability" id="perm_view_availability">
                            <label class="form-check-label" for="perm_view_availability">
                                <i class="fas fa-clock me-2"></i>Saat Durumu Görüntüleme
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="permissions" value="manage_users" id="perm_manage_users">
                            <label class="form-check-label" for="perm_manage_users">
                                <i class="fas fa-users me-2"></i>Kullanıcı Yönetimi
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                        <button type="submit" class="btn btn-primary">Kaydet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function editPermissions(username) {
            const user = {{ users | tojson | safe }};
            const userPermissions = user[username].permissions;
            
            // Formu güncelle
            document.getElementById('permissionsForm').action = `/admin/users/${username}/permissions`;
            
            // Mevcut yetkileri işaretle
            document.querySelectorAll('input[name="permissions"]').forEach(checkbox => {
                checkbox.checked = userPermissions.includes(checkbox.value);
            });
            
            // Modal başlığını güncelle
            document.querySelector('#permissionsModal .modal-title').textContent = `${username} - Kullanıcı Yetkileri`;
            
            // Modal'ı aç
            new bootstrap.Modal(document.getElementById('permissionsModal')).show();
        }

        function resetPassword(username) {
            if (confirm(`${username} kullanıcısının şifresini varsayılan şifreye (123456) sıfırlamak istediğinizden emin misiniz?`)) {
                window.location.href = `/admin/users/${username}/reset-password`;
            }
        }
    </script>
</body>
</html>
